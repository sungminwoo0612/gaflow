version: '3.8'

services:
  # MySQL - MLflow 백엔드 저장소
  mysql:
    image: mysql:8.0
    container_name: mlflow-mysql
    command: ["--log-bin-trust-function-creators=1"]
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: mlflow
      MYSQL_USER: mlflow
      MYSQL_PASSWORD: mlflowpassword
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mlflow-network

  # SeaweedFS Master
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-master
    command: master -ip=seaweedfs-master -port=9333
    ports:
      - "9333:9333"
    networks:
      - mlflow-network

  # SeaweedFS Volume Server
  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-volume
    command: volume -mserver=seaweedfs-master:9333 -port=8080 -ip=seaweedfs-volume
    ports:
      - "8080:8080"
    volumes:
      - seaweedfs_data:/data
    depends_on:
      - seaweedfs-master
    networks:
      - mlflow-network

  # SeaweedFS S3 Gateway
  seaweedfs-s3:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-s3
    command: s3 -filer=seaweedfs-filer:8888 -port=8333 -config=/etc/seaweedfs/s3_config.json
    ports:
      - "8333:8333"
    volumes:
      - ./seaweedfs/s3_config.json:/etc/seaweedfs/s3_config.json:ro
    environment:
      - WEED_S3_DEFAULT_REGION=us-east-1
    depends_on:
      - seaweedfs-filer
    networks:
      - mlflow-network

  # SeaweedFS Filer
  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-filer
    command: filer -master=seaweedfs-master:9333 -ip=seaweedfs-filer -port=8888
    ports:
      - "8888:8888"
    depends_on:
      - seaweedfs-master
    networks:
      - mlflow-network

  # MLflow Server
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: mlflow-server
    command: >
      mlflow server
      --backend-store-uri mysql+pymysql://mlflow:mlflowpassword@mysql:3306/mlflow
      --default-artifact-root s3://mlflow-artifacts/
      --host 0.0.0.0
      --port 5000
    ports:
      - "5000:5000"
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      MLFLOW_S3_ENDPOINT_URL: http://seaweedfs-s3:8333
      MLFLOW_S3_IGNORE_TLS: "true"
    depends_on:
      mysql:
        condition: service_healthy
      seaweedfs-s3:
        condition: service_started
    networks:
      - mlflow-network

  # Adminer - MySQL Admin UI (연결 확인/간단 쿼리용)
  adminer:
    image: adminer
    container_name: adminer
    ports:
      - "8082:8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - mlflow-network

  # CloudBeaver - MySQL Admin UI (MLflow DB 탐색/ERD/SQL 편집용)
  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: cloudbeaver
    ports:
      - "8978:8978"
    volumes:
      - cloudbeaver_data:/opt/cloudbeaver/workspace
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - mlflow-network

volumes:
  mysql_data:
  seaweedfs_data:
  cloudbeaver_data:

networks:
  mlflow-network:
    driver: bridge